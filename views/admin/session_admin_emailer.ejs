<!doctype html>
<html lang="en">
	<head>
	  <meta charset="utf-8">
	  <meta name="viewport" content="width=device-width, initial-scale=1">
	  <title>Admin Session Email</title>
	  <link rel="stylesheet" href="/css/admin.css" type="text/css" />
	  <link rel="stylesheet" href="/css/button.css" type="text/css" />
	  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
	  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	  <script type="text/javascript" src="http://js.nicedit.com/nicEdit-latest.js"></script>
	  <script type="text/javascript">
			var session_id = '<%= req.session.session_id %>';
	  		var users = [];
	  		var userlist = [];
	
			bkLib.onDomLoaded(function() { 
					area2 = new nicEditor({fullPanel : true}).panelInstance('myArea2');
			});
			
			function getMessageContent(){
				var entities = [
			        ['%2B', '+']
			   ] ;
			
				var area2 = new nicEditors.findEditor('myArea2');
				question = area2.getContent();
				var str_esc = escape(question);
				console.log('after escape' + str_esc);
				str_esc= str_esc.replace(entities[0][1], entities[0][0])
				return str_esc;
			}
			
			function addUser(username){
				users.push(username);
				if(userlist){
					userlist = userlist + ',' + username;
				}else{
					userlist = username;
				}
				$('#userlist').text(userlist);
			}
	  		
	  		function findSession(){
				path = "<%=sails.getBaseUrl()%>" + "/session/findById";
				var request= {
					id: session_id,
		            action : path,
		            rand : Math.floor(Math.random()*100000)
		        };
				
				$.post(path,  request,   function(data, status, xhr){	
					console.log(data);
					//displayUsersForSession(data.rows);
					
				}, "json");	
			
			}
		  	
		  	function getUsers(session_id){
				path = "<%=sails.getBaseUrl()%>" + "/sessionuser/findUsersBySession" ;
				var request= {
					session_id: session_id,
		            action : path,
		            rand : Math.floor(Math.random()*100000)
		        };
				
				$.post(path,  request,   function(data, status, xhr){	
					//console.log(data);
					displayUsersForSession(data);
					
				}, "json");	
			
			}
		  	
		  	function displayUsersForSession(users){
		  		console.log(users);
		  		if(users){
		  			$('#users').empty();
		  			
		  			$('#tags').val("");
		  			if(users.length > 0){
		  				buildUserTableHeader();
		  			}
		  			
			  		$.each(users, function (index, user) { 
			  			buildUserRow(user, index);
			  		});
			  		
			  		$("#sessions .row:even").css("background-color","#FBF693");
					$("#sessions .row:odd").css("background-color","#FFFFCE");
		  		}
		  	}
		  	
		  	function buildUserRow(user, index){
		  		index = index + 1;
		  		var row = '<div class="left cell center">' + index + '</div><div class="left cell">' + user.username + 
		  		'</div><div class="left cell">' + user.email + 
		  		'</div><a href="#" onclick="addUser('+ "'" + user.username+ "'" + ')" class="left cell green center">' + 'x' + '</a>';
		  		newdiv = document.createElement( "div" );
		  		$(newdiv).addClass('row clear')
		  		$('#users').append(newdiv);
		  		$(newdiv).append(row);
		  		$(newdiv).append('<div class = "clear"></div>');
		  		
		  	}
		  	
		  	function buildUserTableHeader(){
		  		
		  		var date_header = document.createTextNode('DATE');;
		  		var time_header= document.createTextNode('TIME');;
		  		var delSession = document.createTextNode('DELETE');;
		  		var max = document.createTextNode('MAX');;
		  		var row = '<div class="left cell center">' + '<b>#</b>' + '</div><div class="left cell">' + '<b>Username</b>' + '</div><div class="left cell">' + '<b>Email</b>' + '</div><div">' + '<b>ADD to Emails(future)</b>' + '</div>';
		  		newdiv = document.createElement( "div" );
		  		$(newdiv).addClass('row clear')
		  		$('#users').append(newdiv);
		  		$(newdiv).append(row);
		  		$(newdiv).append('<div class = "clear"></div>');
		  		$(newdiv).append("<div class='vertical_spacer_ten'></div>").css("background-color","#FFFFCE");
		  		
		  	}
		  	
		  	function displayPopup(message){
		  		console.log(message);
		  		$( "#popup" ).dialog({
					autoOpen: true,
					resizable: false,
					position: { my: "left bottom", at: "left+100 bottom-100", of: '#tags' },
				    height: 350,
				    width: 300,
				    
				    modal: true,
				    buttons: {
				        "OK": function() {
				          $( this ).dialog( "close" );
					    }
				    }
				});
				
				$( "#popup" ).html(
					message
				);
		  		
		  	}
		  	
		  	function testEmailer(){
		  		
		  		path = "<%=sails.getBaseUrl()%>" + "/admin/email" ;
		  		console.log(users);
		  		var message = getMessageContent();
		  		
				var request= {
		            users: users,
		            message: message,
					action : path,
		            rand : Math.floor(Math.random()*100000)
		        };
				
				$.post(path,  request,   function(data, status, xhr){	
					console.log(data);
					displaySessions(data.rows);
					
				}, "json");	
		  		
		  	}
		  	
			$( document ).ready(function() {
				findSession();
				getUsers(session_id);
			});
	  </script>
	</head>
	<body>
		<div class='hundred center'><h2>Email Users Message Session Admin Page</h2></div>
		<div class='vertical_spacer_ten'></div>
	 	<div class='vertical_spacer_ten'></div>
		<div class='vertical_spacer_ten'></div>
		<br />
		<br />
		Message editor:
		<br />
		<br />
		<textarea id='myArea2' class='text600' name="area1" cols="40"></textarea>
		<p>
		<div id='userlist'>
		</div>
		</p>
		<br />
		<br />
		<div id='users'>
	 	</div>
		<br />
		<br />
		<div class='hundred button_height '>
			<div class='ninety'>
				 <a href="#" onclick="testEmailer()" class="fifty_w_h  left button dark_grey "><div class="center_text">Test Emailer</div></a>
			</div>
		</div>
		<div class='clear'></div>
		<div class='vertical_spacer_ten'></div>
		<div class='vertical_spacer_ten'></div>
	 	<div class='vertical_spacer_ten'></div>
	 	<p>
	 	Note: Future functionality would be a centralized messaging area to send messages to a list of users managed in this area. There is some functionality in placew which works. If you wish to try this functionality out I can provide a testing scenario and a template which I can create for this.
	 	</p>
	 	<div id='popup'>
		</div>
	</body>
</html>